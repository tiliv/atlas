<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    ...({{ site.data.map.config | jsonify }}),
  });
  const groups = {
    osm: {{ site.data.map.osm | default: [] | jsonify }},
    atlas: {{ site.data.map.atlas | default: [] | jsonify }},
  };

  map.addControl(new maplibregl.NavigationControl({ showCompass: false }), "bottom-right");
  map.on('load', async () => {

    for (const group in groups) {
      for (const source in groups[group]) {
        const layer = groups[group][source];
        map.addSource(source, { type:'geojson', data: `/map/${group}/${layer.file}.geo.json` });
        map.addLayer({ id: `${source}-${layer.type}`, source, ...layer });
      }

      for (const cb of document.querySelectorAll('.map-controls input[type=checkbox]')) {
        // cb.checked = !!spec.visible;
        cb.addEventListener("change", () => {
          const on = cb.checked ? "visible" : "none";
          map.setLayoutProperty(cb.name, "visibility", on);
        });
      }
    }
  });

</script>
